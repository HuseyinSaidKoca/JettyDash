version: '3.3'

services:
  sql-server:
    container_name: sql-server
    image: mcr.microsoft.com/mssql/server:2022-latest
    environment:
      DATABASE_NAME: ${MSSQL_DB}
      ACCEPT_EULA: ${ACCEPT_EULA}
      MSSQL_USER: ${MSSQL_USER}
      MSSQL_SA_PASSWORD: ${MSSQL_SA_PASSWORD}
      MSSQL_PID: ${MSSQL_PID}
    ports:
      - ${MSSQL_PORT}:${MSSQL_PORT}
    volumes:
      - mssql-volume:${MSSQL_VOLUME}
    networks:
      - mssql-networks

  vault:
    image: hashicorp/vault
    container_name: vault
    ports:
      - ${VAULT_PORT}:${VAULT_PORT}
    environment:
      VAULT_DEV_ROOT_TOKEN_ID: ${VAULT_DEV_ROOT_TOKEN_ID}
      VAULT_ADDR: ${VAULT_DEV_LISTEN_ADDRESS}
    restart: always
    networks:
      - vault
      
  setup-vault:
    image: hashicorp/vault
    container_name: setup-vault
    depends_on:
      - vault
    entrypoint: ["sh", "-c", "sleep 10 && vault login -address=${VAULT_ADDR} ${VAULT_DEV_ROOT_TOKEN_ID} && vault secrets enable -path=DatabaseCredential kv"]
    environment:
      VAULT_DEV_ROOT_TOKEN_ID: ${VAULT_DEV_ROOT_TOKEN_ID}
      VAULT_ADDR: http://vault:8200
    networks:
      - vault
    
volumes:
  mssql-volume:

networks:
  vault:
    driver: bridge
  mssql-networks:
    driver: bridge